<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>TEST</title>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.1/css/bootstrap.min.css'/>
</head>
<body>
    <div class="wrapper" id="wrapper">
        <div class="container">
                <h1 class="text-center pt-5 pb-5">USERS</h1>
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Age</th>
                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="user in users">
                            <td class="id">{{ user.id }}</td>
                            <td class="name">{{ user.name }}</td>
                            <td class="email">{{ user.email }}</td>
                            <td class="age">{{ user.age }}</td>
                            <td>
                                <button class="btn btn-info edit">Edit</button>
                            </td>
                            <td>
                                <button type="button" class="btn btn-info delete" @click.prevent="del($event)">Delete</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <hr class="line">
                <form id="users-form" action="#!" method="post">
                    <h2 class="text-center pt-5 pb-5">EDIT</h2>
                    <div class="form-group row">
                        <label for="id" class="form-label col-2">Id:</label>
                        <input type="tel" name="id" class="form-control col-10" required>
                    </div>
                    <div class="form-group row">
                        <label for="name" class="form-label col-2">Name:</label>
                        <input type="text" name="name" class="form-control col-10">
                    </div>
                    <div class="form-group row">
                        <label for="email" class="form-label col-2">Email:</label>
                        <input type="email" name="email" class="form-control col-10">
                    </div>
                    <div class="form-group row">
                        <label for="age" class="form-label col-2">Age:</label>
                        <input type="tel" name="age" class="form-control col-10">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-info add-btn" v-on:click.prevent="add" type="button">ADD</button>
                        <a class="btn btn-info update-btn">UPDATE</a>
                    </div>
                </form>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.16/vue.min.js'></script>
    <script>

        const endpoint = '/api/users';
        let user = {};

        var app = new Vue({
            el: '#wrapper',
            data: {
                users: null
            },
            computed: {
                getUser(){
                    let form = $('#users-form')[0];
                    let id = form.elements['id'].value || '';
                    let name = form.elements['name'].value || '';
                    let email = form.elements['email'].value || '';
                    let age = form.elements['age'].value || '';
                    user = {id,name,email,age}
                    return user;
                }
            },
            methods: {
                get(){
                    $.ajax({url: endpoint}).done(res => this.users = (typeof res === 'string') ? JSON.parse(res) : res);
                },
                add(){
                    let form = $('#users-form')[0];
                    let id = form.elements['id'].value || '';
                    let name = form.elements['name'].value || '';
                    let email = form.elements['email'].value || '';
                    let age = form.elements['age'].value || '';
                    user = {id,name,email,age}
                    if (user.id != "") {
                        $.post(endpoint, user, function(data){
                            console.log(data.message);
                            $('input').val('');
                        });
                        this.get();
                    } else {
                        alert("請輸入ID!!");
                    }
                },
                update(){},
                del(event){
                    console.log(event.target);
                    let id = $(event.target.parentNode).prevAll('.id')[0].innerText;
                    $.ajax({
                        url: endpoint + '/' + id,
                        type:"delete"
                    }).done(function(data){
                        alert(data.message);
                        $(event.target.parentNode.parentNode).remove();
                    });
                    this.get();
                }
            },
            mounted(){
                $.ajax({url: endpoint}).done(res => this.users = (typeof res === 'string') ? JSON.parse(res) : res);
            }
        });
    </script>
</body>
</html>